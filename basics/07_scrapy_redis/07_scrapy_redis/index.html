



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="jusk9527">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.1">
    
    
      
        <title>Scrapy 源码 scrapy-redis - Let's Scrapy!</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#scrapy-redis" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Let's Scrapy!" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Let's Scrapy!
            </span>
            <span class="md-header-nav__topic">
              
                Scrapy 源码 scrapy-redis
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jusk9527/LetsScrapy/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LetsScrapy
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Let's Scrapy!" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Let's Scrapy!
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jusk9527/LetsScrapy/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LetsScrapy
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="简介" class="md-nav__link">
      简介
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Scrapy 基础
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Scrapy 基础
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../11_scrapy_index/11_scrapy_index/" title="Scrapy 简单介绍" class="md-nav__link">
      Scrapy 简单介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../00_scrapy_setting/00_scrapy_setting/" title="Scrapy 源码 settings" class="md-nav__link">
      Scrapy 源码 settings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../01_scrapy_request_response/01_scrapy_request_response/" title="Scrapy 源码 request、response" class="md-nav__link">
      Scrapy 源码 request、response
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../02_scrapy_spider/02_scrapy_spider/" title="Scrapy 源码 Spider" class="md-nav__link">
      Scrapy 源码 Spider
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../03_scrapy_crawlspiders/03_scrapy_crawlspiders/" title="Scrapy 源码 CrawlSpider" class="md-nav__link">
      Scrapy 源码 CrawlSpider
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../04_scrapy_middlewares/04_scrapy_middlewares/" title="Scrapy 源码 Middewares" class="md-nav__link">
      Scrapy 源码 Middewares
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../05_scrapy_piplines/05_scrapy_piplines/" title="Scrapy 源码 pipelines" class="md-nav__link">
      Scrapy 源码 pipelines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../06_scrapy_log/06_scrapy_log/" title="Scrapy 源码 log" class="md-nav__link">
      Scrapy 源码 log
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Scrapy 源码 scrapy-redis
      </label>
    
    <a href="./" title="Scrapy 源码 scrapy-redis" class="md-nav__link md-nav__link--active">
      Scrapy 源码 scrapy-redis
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scrapy-redis" title="Scrapy-redis" class="md-nav__link">
    Scrapy-redis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scrapy-redis_1" title="scrapy-redis正式登场" class="md-nav__link">
    scrapy-redis正式登场
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" title="总结" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="思考" class="md-nav__link">
    思考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="参考资料" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../08_scrapy_scrapyd/08_scrapy_scrapyd/" title="Scrapy scrapyd" class="md-nav__link">
      Scrapy scrapyd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../09_python_scrapyd_api/09_python_scrapyd_api/" title="Scrapy scrapyd-api" class="md-nav__link">
      Scrapy scrapyd-api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../10_scrapy_splash/10_scrapy_splash/" title="Scrapy splash" class="md-nav__link">
      Scrapy splash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../12_scrapy_实战项目/12_scrapy_实战项目/" title="Scrapy 实战项目" class="md-nav__link">
      Scrapy 实战项目
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scrapy-redis" title="Scrapy-redis" class="md-nav__link">
    Scrapy-redis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scrapy-redis_1" title="scrapy-redis正式登场" class="md-nav__link">
    scrapy-redis正式登场
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" title="总结" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="思考" class="md-nav__link">
    思考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="参考资料" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jusk9527/LetsScrapy/edit/master/docs/basics/07_scrapy_redis/07_scrapy_redis.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Scrapy 源码 scrapy-redis</h1>
                
                <h2 id="scrapy-redis">Scrapy-redis<a class="headerlink" href="#scrapy-redis" title="Permanent link">&para;</a></h2>
<p><img alt="" src="http://q9vzy95p2.bkt.clouddn.com//20200526102142.png" /></p>
<p>作为对scrapy 框架的补充。在大规模应用中有着广泛的基础，我们实际来看一看他到底对scrapy做了哪些补充，为什么如此受欢迎</p>
<p>从架构图中我们可以知道他是对scrapy本身的scheduler进行了改造。那到底什么是scheduleer(调度器)呢？先查下他的源码</p>
<ul>
<li>scrapy.core.scheduler</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c1"># scrapy.core.scheduler.py:</span>

<span class="n">class</span> <span class="nf">Scheduler</span><span class="p">(</span><span class="n">object</span><span class="p">):</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Scrapy Scheduler. It allows to enqueue requests and then get</span>
<span class="s2">    a next request to download. Scheduler is also handling duplication</span>
<span class="s2">    filtering, via dupefilter.</span>

<span class="s2">    Prioritization and queueing is not performed by the Scheduler.</span>
<span class="s2">    User sets ``priority`` field for each Request, and a PriorityQueue</span>
<span class="s2">    (defined by :setting:`SCHEDULER_PRIORITY_QUEUE`) uses these priorities</span>
<span class="s2">    to dequeue requests in a desired order.</span>

<span class="s2">    Scheduler uses two PriorityQueue instances, configured to work in-memory</span>
<span class="s2">    and on-disk (optional). When on-disk queue is present, it is used by</span>
<span class="s2">    default, and an in-memory queue is used as a fallback for cases where</span>
<span class="s2">    a disk queue can&#39;t handle a request (can&#39;t serialize it).</span>

<span class="s2">    :setting:`SCHEDULER_MEMORY_QUEUE` and</span>
<span class="s2">    :setting:`SCHEDULER_DISK_QUEUE` allow to specify lower-level queue classes</span>
<span class="s2">    which PriorityQueue instances would be instantiated with, to keep requests</span>
<span class="s2">    on disk and in memory respectively.</span>

<span class="s2">    Overall, Scheduler is an object which holds several PriorityQueue instances</span>
<span class="s2">    (in-memory and on-disk) and implements fallback logic for them.</span>
<span class="s2">    Also, it handles dupefilters.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dupefilter</span><span class="p">,</span> <span class="n">jobdir</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">dqclass</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">mqclass</span><span class="o">=</span><span class="n">None</span><span class="p">,</span>
                 <span class="n">logunser</span><span class="o">=</span><span class="no">False</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">pqclass</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">crawler</span><span class="o">=</span><span class="n">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">dupefilter</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dqdir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dqdir</span><span class="p">(</span><span class="n">jobdir</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pqclass</span> <span class="o">=</span> <span class="n">pqclass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dqclass</span> <span class="o">=</span> <span class="n">dqclass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mqclass</span> <span class="o">=</span> <span class="n">mqclass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logunser</span> <span class="o">=</span> <span class="n">logunser</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
        <span class="n">self</span><span class="p">.</span><span class="n">crawler</span> <span class="o">=</span> <span class="n">crawler</span>

    <span class="c1"># 可以看到这是一个钩子，他能访问当前爬虫的配置，然后载入</span>
    <span class="o">@</span><span class="n">classmethod</span>
    <span class="n">def</span> <span class="nf">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">crawler</span><span class="p">.</span><span class="n">settings</span>

        <span class="c1"># 获取去重用的类，默认是scrapy.dupefilters.RFPDupeFilter</span>
        <span class="n">dupefilter_cls</span> <span class="o">=</span> <span class="nf">load_object</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DUPEFILTER_CLASS&#39;</span><span class="p">])</span>

        <span class="c1"># 我们可以跟踪下load_obj()这个方法</span>
        <span class="c1"># def load_object(path):</span>
        <span class="c1">#     &quot;&quot;&quot;Load an object given its absolute object path, and return it.</span>
        <span class="c1">#</span>
        <span class="c1">#     object can be a class, function, variable or an instance.</span>
        <span class="c1">#     path ie: &#39;scrapy.downloadermiddlewares.redirect.RedirectMiddleware&#39;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#     返回路径指定的类对象，比如path:scrapy.downloadermiddlewares.redirect.RedirectMiddleware，他返回的是</span>
        <span class="c1">#      RedirectMiddleware这个对象</span>
        <span class="c1">#     &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         # 返回子字符串 str 在字符串中最后出现的位置，出现在字符串path中出现的位置，如果没有匹配的字符串会报异常。</span>
        <span class="c1">#         dot = path.rindex(&#39;.&#39;)</span>
        <span class="c1">#     except ValueError:</span>
        <span class="c1">#         raise ValueError(&quot;Error loading object &#39;%s&#39;: not a full path&quot; % path)</span>
        <span class="c1">#</span>
        <span class="c1">#     # 这里将模块和名字给出啦，比如正常就返回model=scrapy.spiderloader|||name=SpiderLoader</span>
        <span class="c1">#     module, name = path[:dot], path[dot + 1:]</span>
        <span class="c1">#     mod = import_module(module)</span>
        <span class="c1">#</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         obj = getattr(mod, name)</span>
        <span class="c1">#     except AttributeError:</span>
        <span class="c1">#         raise NameError(&quot;Module &#39;%s&#39; doesn&#39;t define any object named &#39;%s&#39;&quot; % (module, name))</span>
        <span class="c1">#</span>
        <span class="c1">#     return obj</span>




        <span class="c1"># 创建一个实例对象，对对象的一些属性做一些判断</span>
        <span class="n">dupefilter</span> <span class="o">=</span> <span class="nf">create_instance</span><span class="p">(</span><span class="n">dupefilter_cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">crawler</span><span class="p">)</span>

        <span class="c1"># 获取优先级队列， 默认：queuelib.pqueue.PriorityQueue，类对象（SCHEDULER_PRIORITY_QUEUE）</span>
        <span class="n">pqclass</span> <span class="o">=</span> <span class="nf">load_object</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SCHEDULER_PRIORITY_QUEUE&#39;</span><span class="p">])</span>



        <span class="c1"># 判断一些获得的这个pqclass队列对象是就是PriorityQueue这个对象，是的话发出警告，并将ScrapyPriorityQueue这个对象</span>
        <span class="c1"># 赋值给ScrapyPriorityQueue</span>
        <span class="k">if</span> <span class="n">pqclass</span> <span class="k">is</span> <span class="n">PriorityQueue</span><span class="p">:</span>
            <span class="n">warnings</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="s2">&quot;SCHEDULER_PRIORITY_QUEUE=&#39;queuelib.PriorityQueue&#39;&quot;</span>
                          <span class="s2">&quot; is no longer supported because of API changes; &quot;</span>
                          <span class="s2">&quot;please use &#39;scrapy.pqueues.ScrapyPriorityQueue&#39;&quot;</span><span class="p">,</span>
                          <span class="n">ScrapyDeprecationWarning</span><span class="p">)</span>
            <span class="k">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">pqueues</span> <span class="n">import</span> <span class="n">ScrapyPriorityQueue</span>
            <span class="n">pqclass</span> <span class="o">=</span> <span class="n">ScrapyPriorityQueue</span>

        <span class="c1"># 获取磁盘队列 类对象（SCHEDULER_DISK_QUEUE,重启不会丢失）</span>
        <span class="n">dqclass</span> <span class="o">=</span> <span class="nf">load_object</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SCHEDULER_DISK_QUEUE&#39;</span><span class="p">])</span>

        <span class="c1"># 获取内存队列 类对象(SCHEDULER 使用内存存储，重启会丢失)</span>
        <span class="n">mqclass</span> <span class="o">=</span> <span class="nf">load_object</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SCHEDULER_MEMORY_QUEUE&#39;</span><span class="p">])</span>

        <span class="c1"># 是否开启debug</span>
        <span class="n">logunser</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="nf">getbool</span><span class="p">(</span><span class="s1">&#39;LOG_UNSERIALIZABLE_REQUESTS&#39;</span><span class="p">,</span>
                                    <span class="n">settings</span><span class="p">.</span><span class="nf">getbool</span><span class="p">(</span><span class="s1">&#39;SCHEDULER_DEBUG&#39;</span><span class="p">))</span>

        <span class="c1"># 将这些参数传递给 __init__ 方法</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">dupefilter</span><span class="p">,</span> <span class="n">jobdir</span><span class="o">=</span><span class="nf">job_dir</span><span class="p">(</span><span class="n">settings</span><span class="p">),</span> <span class="n">logunser</span><span class="o">=</span><span class="n">logunser</span><span class="p">,</span>
                   <span class="n">stats</span><span class="o">=</span><span class="n">crawler</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">pqclass</span><span class="o">=</span><span class="n">pqclass</span><span class="p">,</span> <span class="n">dqclass</span><span class="o">=</span><span class="n">dqclass</span><span class="p">,</span>
                   <span class="n">mqclass</span><span class="o">=</span><span class="n">mqclass</span><span class="p">,</span> <span class="n">crawler</span><span class="o">=</span><span class="n">crawler</span><span class="p">)</span>

    <span class="c1"># 检查是否有没有处理的请求</span>
    <span class="n">def</span> <span class="nf">has_pending_requests</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Engin创建完之后会调用这个方法</span>
    <span class="n">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>

        <span class="n">self</span><span class="p">.</span><span class="n">spider</span> <span class="o">=</span> <span class="n">spider</span>


        <span class="c1"># 创建一个有优先级的内存队列 实例化对象</span>
        <span class="c1"># self.pqclass 默认是：queuelib.pqueue.PriorityQueue</span>
        <span class="c1"># self._newmq 会返回一个内存队列的 实例化对象 在110  111 行</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mqs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mq</span><span class="p">()</span>
        <span class="c1"># 如果self.dqdir 有设置 就创建一个磁盘队列 否则self.dqs 为空</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dqs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dq</span><span class="p">()</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dqdir</span> <span class="k">else</span> <span class="n">None</span>

        <span class="c1"># 获得一个去重实例对象 open 方法是从BaseDupeFilter继承的</span>
        <span class="c1"># 现在我们可以用self.df来去重啦</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nf">open</span><span class="p">()</span>

    <span class="c1"># 当Engine关闭的时候</span>
    <span class="n">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="c1"># 如果有磁盘队列 则对其进行dump后保存到active.json文件中</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_dqs_state</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dqdir</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="c1"># 然后关闭去重</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

    <span class="c1"># 添加一个Request进调度队列</span>
    <span class="n">def</span> <span class="nf">enqueue_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="k">not</span> <span class="n">request</span><span class="p">.</span><span class="n">dont_filter</span> <span class="k">and</span> <span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nf">request_seen</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

            <span class="c1"># 如果Request的dont_filter属性没有设置（默认为False）和 已经存在则去重</span>
            <span class="c1"># 不push进队列</span>
            <span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">return</span> <span class="no">False</span>

        <span class="c1"># 先尝试将Request push进磁盘队列</span>
        <span class="n">dqok</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dqpush</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dqok</span><span class="p">:</span>

            <span class="c1"># 如果成功 则在记录一次状态</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/enqueued/disk&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># 不能添加进磁盘队列则会添加进内存队列</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_mqpush</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/enqueued/memory&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/enqueued&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span> <span class="no">True</span>


    <span class="c1"># 从队列中获取一个Request</span>
    <span class="n">def</span> <span class="nf">next_request</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">mqs</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/dequeued/memory&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># 不能获取的时候从磁盘队列队里获取</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dqpop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/dequeued/disk&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/dequeued&#39;</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>

        <span class="c1"># 将获取的到Request返回给Engine</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="n">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">)</span> <span class="o">+</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mqs</span><span class="p">)</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span> <span class="k">else</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mqs</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">_dqpush</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span> <span class="k">is</span> <span class="n">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">request</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">except</span> <span class="n">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># non serializable request</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">logunser</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Unable to serialize request: %(request)s - reason:&quot;</span>
                       <span class="s2">&quot; %(reason)s - no more unserializable requests will be&quot;</span>
                       <span class="s2">&quot; logged (stats being collected)&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="err">{</span><span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">e</span><span class="err">}</span><span class="p">,</span>
                               <span class="n">exc_info</span><span class="o">=</span><span class="no">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="err">}</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">logunser</span> <span class="o">=</span> <span class="no">False</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/unserializable&#39;</span><span class="p">,</span>
                                 <span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="no">True</span>

    <span class="n">def</span> <span class="nf">_mqpush</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mqs</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">request</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">_dqpop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>

    <span class="n">def</span> <span class="nf">_newmq</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot; Factory for creating memory queues. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">mqclass</span><span class="p">()</span>

    <span class="n">def</span> <span class="nf">_newdq</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot; Factory for creating disk queues. &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="k">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dqdir</span><span class="p">,</span> <span class="s1">&#39;p%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">dqclass</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">_mq</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot; Create a new priority queue instance, with in-memory storage &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nf">create_instance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pqclass</span><span class="p">,</span> <span class="n">None</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_newmq</span><span class="p">,</span>
                               <span class="n">serialize</span><span class="o">=</span><span class="no">False</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">_dq</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot; Create a new priority queue instance, with disk storage &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_dqs_state</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dqdir</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nf">create_instance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pqclass</span><span class="p">,</span>
                            <span class="n">None</span><span class="p">,</span>
                            <span class="n">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">,</span>
                            <span class="n">self</span><span class="p">.</span><span class="n">_newdq</span><span class="p">,</span>
                            <span class="n">state</span><span class="p">,</span>
                            <span class="n">serialize</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">&quot;Resuming crawl (%(queuesize)d requests scheduled)&quot;</span><span class="p">,</span>
                        <span class="err">{</span><span class="s1">&#39;queuesize&#39;</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="err">}</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="err">}</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="n">def</span> <span class="nf">_dqdir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">jobdir</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot; Return a folder name to keep disk queue state at &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">jobdir</span><span class="p">:</span>
            <span class="n">dqdir</span> <span class="o">=</span> <span class="k">join</span><span class="p">(</span><span class="n">jobdir</span><span class="p">,</span> <span class="s1">&#39;requests.queue&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span><span class="p">(</span><span class="n">dqdir</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">dqdir</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dqdir</span>

    <span class="n">def</span> <span class="nf">_read_dqs_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dqdir</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="k">join</span><span class="p">(</span><span class="n">dqdir</span><span class="p">,</span> <span class="s1">&#39;active.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="k">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">_write_dqs_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dqdir</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="k">join</span><span class="p">(</span><span class="n">dqdir</span><span class="p">,</span> <span class="s1">&#39;active.json&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>

<p>我们知道了这个SCHEDULER(调度器)主要是完成了push Request pop Request去重操作，而且是queue(队列)操作是在内存队列中完成的</p>
<p>去重的源码我们进一步了解下</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">scrapy</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">scheduler</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="n">RFPDupeFilter</span><span class="p">(</span><span class="n">BaseDupeFilter</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;请求指纹重复筛选&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">集合去重啊</span><span class="err">！</span><span class="n">集合那就是在内存中</span><span class="err">，</span><span class="n">这点很重要</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">fingerprints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">set</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">logdupes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debug</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">path</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">去看到去重其实打开了一个requests</span><span class="p">.</span><span class="n">seen的文件</span><span class="w"></span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">如果是使用的磁盘的话</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="k">path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;requests.seen&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;a+&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">#将文件中的请求更新到内存集合中去</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">fingerprints</span><span class="p">.</span><span class="k">update</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_settings</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;DUPEFILTER_DEBUG&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">(</span><span class="n">job_dir</span><span class="p">(</span><span class="n">settings</span><span class="p">),</span><span class="w"> </span><span class="n">debug</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">request_seen</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">fingerprints</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">判断我们的请求是否在这个集合中</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">True</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">fingerprints</span><span class="p">.</span><span class="k">add</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">如果用的磁盘队列就写进去记录一下</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">fp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">linesep</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">file</span><span class="p">.</span><span class="k">close</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">#log日志</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">debug</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Filtered duplicate request: %(request)s (referer: %(referer)s)&quot;</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;request&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;referer&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">referer_str</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="err">}</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">logdupes</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;Filtered duplicate request: %(request)s&quot;</span><span class="w"></span>
<span class="w">                   </span><span class="ss">&quot; - no more duplicates will be shown&quot;</span><span class="w"></span>
<span class="w">                   </span><span class="ss">&quot; (see DUPEFILTER_DEBUG to show all duplicates)&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;request&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">request</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="err">}</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logdupes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">        </span><span class="n">spider</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s1">&#39;dupefilter/filtered&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">去重我们知道了！一个是利用磁盘打开个文件，这样就能关闭爬虫就不会丢失数据了，一个就是利用集合使用内存的方式去重，优点是快，但是关闭爬虫就会丢失数据。</span>
</code></pre></div>
</td></tr></table>

<hr />
<h2 id="scrapy-redis_1">scrapy-redis正式登场<a class="headerlink" href="#scrapy-redis_1" title="Permanent link">&para;</a></h2>
<p>我们了解了scrapy 的调度器是如何工作的情况下我们能否改装下呢？那是可以的</p>
<p>我们可以看下他的源码</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>git clone https://github.com/rmax/scrapy-redis.git
</code></pre></div>
</td></tr></table>

<p>他的源码是在src下</p>
<p><img alt="" src="http://q9vzy95p2.bkt.clouddn.com//20200527144723.png" /></p>
<p>先看他重写scheduler(调度器)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">Scheduler</span><span class="p">(</span><span class="k">object</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Redis-based scheduler</span>

<span class="ss">    Settings</span>
<span class="ss">    --------</span>
<span class="ss">    SCHEDULER_PERSIST : bool (default: False)</span>
<span class="ss">        Whether to persist or clear redis queue.</span>
<span class="ss">    SCHEDULER_FLUSH_ON_START : bool (default: False)</span>
<span class="ss">        Whether to flush redis queue on start.</span>
<span class="ss">    SCHEDULER_IDLE_BEFORE_CLOSE : int (default: 0)</span>
<span class="ss">        How many seconds to wait before closing if no message is received.</span>
<span class="ss">    SCHEDULER_QUEUE_KEY : str</span>
<span class="ss">        Scheduler redis key.</span>
<span class="ss">    SCHEDULER_QUEUE_CLASS : str</span>
<span class="ss">        Scheduler queue class.</span>
<span class="ss">    SCHEDULER_DUPEFILTER_KEY : str</span>
<span class="ss">        Scheduler dupefilter redis key.</span>
<span class="ss">    SCHEDULER_DUPEFILTER_CLASS : str</span>
<span class="ss">        Scheduler dupefilter class.</span>
<span class="ss">    SCHEDULER_SERIALIZER : str</span>
<span class="ss">        Scheduler serializer.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">persist</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">flush_on_start</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">queue_key</span><span class="o">=</span><span class="n">defaults</span><span class="p">.</span><span class="n">SCHEDULER_QUEUE_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">queue_cls</span><span class="o">=</span><span class="n">defaults</span><span class="p">.</span><span class="n">SCHEDULER_QUEUE_CLASS</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">dupefilter_key</span><span class="o">=</span><span class="n">defaults</span><span class="p">.</span><span class="n">SCHEDULER_DUPEFILTER_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">dupefilter_cls</span><span class="o">=</span><span class="n">defaults</span><span class="p">.</span><span class="n">SCHEDULER_DUPEFILTER_CLASS</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">idle_before_close</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">serializer</span><span class="o">=</span><span class="k">None</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Initialize scheduler.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        server : Redis</span>
<span class="ss">            The redis server instance.</span>
<span class="ss">        persist : bool</span>
<span class="ss">            Whether to flush requests when closing. Default is False.</span>
<span class="ss">        flush_on_start : bool</span>
<span class="ss">            Whether to flush requests on start. Default is False.</span>
<span class="ss">        queue_key : str</span>
<span class="ss">            Requests queue key.</span>
<span class="ss">        queue_cls : str</span>
<span class="ss">            Importable path to the queue class.</span>
<span class="ss">        dupefilter_key : str</span>
<span class="ss">            Duplicates filter key.</span>
<span class="ss">        dupefilter_cls : str</span>
<span class="ss">            Importable path to the dupefilter class.</span>
<span class="ss">        idle_before_close : int</span>
<span class="ss">            Timeout before giving up.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>


<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>
<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        server : Redis</span>
<span class="ss">            这是Redis实例</span>
<span class="ss">        persist : bool</span>
<span class="ss">            是否在关闭时清空Requests.默认值是False。</span>
<span class="ss">        flush_on_start : bool</span>
<span class="ss">            是否在启动时清空Requests。 默认值是False。</span>
<span class="ss">        queue_key : str</span>
<span class="ss">            Request队列的Key名字</span>
<span class="ss">        queue_cls : str</span>
<span class="ss">            队列的可导入路径（就是使用什么队列）</span>
<span class="ss">        dupefilter_key : str</span>
<span class="ss">            去重队列的Key</span>
<span class="ss">        dupefilter_cls : str</span>
<span class="ss">            去重类的可导入路径。</span>
<span class="ss">        idle_before_close : int</span>
<span class="ss">            等待多久关闭</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">idle_before_close</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">TypeError</span><span class="p">(</span><span class="ss">&quot;idle_before_close cannot be negative&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">persist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">persist</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">flush_on_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flush_on_start</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">queue_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_key</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">queue_cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_cls</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dupefilter_cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dupefilter_cls</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dupefilter_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dupefilter_key</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">idle_before_close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idle_before_close</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">serializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serializer</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span><span class="w"></span>



<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_settings</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">从setting中导入参数</span><span class="w"></span>
<span class="w">        </span><span class="n">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;persist&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;SCHEDULER_PERSIST&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;flush_on_start&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;SCHEDULER_FLUSH_ON_START&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;idle_before_close&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;SCHEDULER_IDLE_BEFORE_CLOSE&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="err">}</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">missing</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">defaults</span><span class="p">.</span><span class="w"></span>
<span class="w">        </span><span class="n">optional</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nl">TODO</span><span class="p">:</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">prefixes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">note</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">are</span><span class="w"></span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">scrapy</span><span class="o">-</span><span class="n">redis</span><span class="p">.</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;queue_key&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;SCHEDULER_QUEUE_KEY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;queue_cls&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;SCHEDULER_QUEUE_CLASS&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;dupefilter_key&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;SCHEDULER_DUPEFILTER_KEY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">compatibility</span><span class="p">.</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;dupefilter_cls&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;DUPEFILTER_CLASS&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;serializer&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;SCHEDULER_SERIALIZER&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="err">}</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">从setting</span><span class="w"> </span><span class="n">中获取配置组装成dict</span><span class="p">(</span><span class="n">具体获取哪些配置是optional字典中key</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">setting_name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">optional</span><span class="p">.</span><span class="n">items</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">setting_name</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nl">val</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">kwargs</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Support</span><span class="w"> </span><span class="n">serializer</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">path</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">module</span><span class="p">.</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">&#39;serializer&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">six</span><span class="p">.</span><span class="n">string_types</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;serializer&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importlib</span><span class="p">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;serializer&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">获取一个Redis</span><span class="w"> </span><span class="n">连接</span><span class="w"></span>
<span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">connection</span><span class="p">.</span><span class="n">from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">connection</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">working</span><span class="p">.</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">确保连接正常</span><span class="w"></span>
<span class="w">        </span><span class="n">server</span><span class="p">.</span><span class="n">ping</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">crawler</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="n">from_settings</span><span class="p">(</span><span class="n">crawler</span><span class="p">.</span><span class="n">settings</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">FIXME</span><span class="p">:</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">constructor</span><span class="w"></span>
<span class="w">        </span><span class="n">instance</span><span class="p">.</span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crawler</span><span class="p">.</span><span class="n">stats</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spider</span><span class="w"></span>

<span class="w">        </span><span class="k">try</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">根据self</span><span class="p">.</span><span class="n">queue_cls这个可以导入的类</span><span class="err">，</span><span class="n">实例化一个队列</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_object</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue_cls</span><span class="p">)(</span><span class="w"></span>
<span class="w">                </span><span class="n">server</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">server</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">queue_key</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="p">.</span><span class="n">name</span><span class="err">}</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">serializer</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">serializer</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="n">TypeError</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Failed to instantiate queue class &#39;%s&#39;: %s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">self</span><span class="p">.</span><span class="n">queue_cls</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">根据self</span><span class="p">.</span><span class="n">dupefilter_cls</span><span class="w"> </span><span class="n">这个可以导入的类</span><span class="err">，</span><span class="n">实例一个去重集合</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">默认是集合</span><span class="err">，</span><span class="n">可以实现自己的去重方式</span><span class="err">，</span><span class="n">比如bool去重</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_object</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dupefilter_cls</span><span class="p">).</span><span class="n">from_spider</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">flush_on_start</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">notice</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">resume</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">crawl</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">spider</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;Resuming crawl (%d requests scheduled)&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">persist</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">enqueue_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>
<span class="ss">        这个和scrapy 本身的一样</span>
<span class="ss">        :param request:</span>
<span class="ss">        :return:</span>
<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">dont_filter</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">request_seen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">False</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">stats</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/enqueued/redis&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">向队列里添加一个Request</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">next_request</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>
<span class="ss">        获取一个Request</span>
<span class="ss">        :return:</span>
<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">block_pop_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">idle_before_close</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">block_pop_timeout</span><span class="w"> </span><span class="n">是一个等待参数</span><span class="err">，</span><span class="n">队列没有东西会等待这个时间</span><span class="err">，</span><span class="n">超时就会关闭</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">block_pop_timeout</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">stats</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s1">&#39;scheduler/dequeued/redis&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">判断是否还有未调度的请求</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">has_pending_requests</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>除了调度器改写了,我们还看到源码总还有queue 这是对队列进行了改装，我们看一下队列到底改造了什么</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c1"># scrapy_redis.queue.py</span>
<span class="k">class</span> <span class="n">PriorityQueue</span>(<span class="n">Base</span>):
    <span class="s">&quot;&quot;&quot;Per-spider priority queue abstraction using redis&#39; sorted set&quot;&quot;&quot;</span>
    <span class="s">&quot;&quot;&quot;其实就是使用Redis的有序集合，来对Request进行排序，这样就可以优先级高的在有序集合的顶层 我们只需要</span>
<span class="s">    从上往下获取Request即可&quot;&quot;&quot;</span>

    <span class="n">def</span> <span class="n">__len__</span>(<span class="k">self</span>):
        <span class="s">&quot;&quot;&quot;Return the length of the queue&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">self</span>.<span class="n">server</span>.<span class="n">zcard</span>(<span class="k">self</span>.<span class="nb">key</span>)

    <span class="n">def</span> <span class="nb">push</span>(<span class="k">self</span>, <span class="n">request</span>):
        <span class="s">&quot;&quot;&quot;Push a request&quot;&quot;&quot;</span>

        <span class="s">&quot;&quot;&quot;添加一个Request进队列&quot;&quot;&quot;</span>

        <span class="c1"># self._encode_request(request)将Request请求序列化</span>
        <span class="n">data</span> = <span class="k">self</span>.<span class="n">_encode_request</span>(<span class="n">request</span>)

        <span class="s">&quot;&quot;&quot;</span>
<span class="s">        d = {</span>
<span class="s">        &#39;url&#39;: to_unicode(request.url),  # urls should be safe (safe_string_url)</span>
<span class="s">        &#39;callback&#39;: cb,</span>
<span class="s">        &#39;errback&#39;: eb,</span>
<span class="s">        &#39;method&#39;: request.method,</span>
<span class="s">        &#39;headers&#39;: dict(request.headers),</span>
<span class="s">        &#39;body&#39;: request.body,</span>
<span class="s">        &#39;cookies&#39;: request.cookies,</span>
<span class="s">        &#39;meta&#39;: request.meta,</span>
<span class="s">        &#39;_encoding&#39;: request._encoding,</span>
<span class="s">        &#39;priority&#39;: request.priority,</span>
<span class="s">        &#39;dont_filter&#39;: request.dont_filter,</span>
<span class="s">        &#39;flags&#39;: request.flags,</span>
<span class="s">        &#39;_class&#39;: request.__module__ + &#39;.&#39; + request.__class__.__name__</span>
<span class="s">            }</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="c1"># data 就是上面这个字典的序列化，在Scrapy.util.reqser.py中的request_to_dict方法中处理</span>

        <span class="c1"># 在redis 有序集合中数值越小优先级越高（就是会被放在顶层） 所以这个位置是取得相反数</span>
        <span class="n">score</span> = -<span class="n">request</span>.<span class="n">priority</span>
        <span class="c1"># We don&#39;t use zadd method as the order of arguments change depending on</span>
        <span class="c1"># whether the class is Redis or StrictRedis, and the option of using</span>
        <span class="c1"># kwargs only accepts strings, not bytes.</span>

        <span class="c1"># ZADD 是添加进来有序集合</span>
        <span class="k">self</span>.<span class="n">server</span>.<span class="n">execute_command</span>(<span class="s">&#39;ZADD&#39;</span>, <span class="k">self</span>.<span class="nb">key</span>, <span class="n">score</span>, <span class="n">data</span>)

    <span class="n">def</span> <span class="nb">pop</span>(<span class="k">self</span>, <span class="n">timeout</span>=<span class="mi">0</span>):
        <span class="s">&quot;&quot;&quot;</span>
<span class="s">        Pop a request</span>
<span class="s">        timeout not support in this queue class</span>

<span class="s">        有序集合不支持超时就木有使用timeout了 这个timeout就是挂羊头买狗肉</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="c1"># use atomic range/remove using multi/exec</span>
        <span class="n">pipe</span> = <span class="k">self</span>.<span class="n">server</span>.<span class="n">pipeline</span>()
        <span class="n">pipe</span>.<span class="k">multi</span>()

        <span class="c1"># 取出 顶层第一个</span>
        <span class="c1"># zrange : 返回有序集 key 中，指定区间内的成员 0，0 就是第一个</span>
        <span class="c1"># zremrangebyrank:移除有序集key 中，指定排名（rank） 区间内的所有成员 0，0也就是第一个了</span>
        <span class="n">pipe</span>.<span class="n">zrange</span>(<span class="k">self</span>.<span class="nb">key</span>, <span class="mi">0</span>, <span class="mi">0</span>).<span class="n">zremrangebyrank</span>(<span class="k">self</span>.<span class="nb">key</span>, <span class="mi">0</span>, <span class="mi">0</span>)
        <span class="n">results</span>, <span class="nb">count</span> = <span class="n">pipe</span>.<span class="n">execute</span>()
        <span class="k">if</span> <span class="n">results:</span>
            <span class="k">return</span> <span class="k">self</span>.<span class="n">_decode_request</span>(<span class="n">results</span>[<span class="mi">0</span>])
</code></pre></div>
</td></tr></table>

<p>是一个普通的队列，放redis里面先进先出</p>
<p>除了队列进行了改装，还有对去重也进行了改装，我们来看看去重是如何改装的</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">scrapy_redis</span><span class="p">.</span><span class="n">dupefilter</span><span class="p">.</span><span class="n">py</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="n">RFPDupeFilter</span><span class="p">(</span><span class="n">BaseDupeFilter</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Redis-based request duplicates filter.</span>

<span class="ss">    This class can also be used with default Scrapy&#39;s scheduler.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logger</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Initialize the duplicates filter.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        server : redis.StrictRedis</span>
<span class="ss">            The redis server instance.</span>
<span class="ss">        key : str</span>
<span class="ss">            Redis key Where to store fingerprints.</span>
<span class="ss">        debug : bool, optional</span>
<span class="ss">            Whether to log filtered requests.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">key</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debug</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">logdupes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_settings</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Returns an instance from given settings.</span>

<span class="ss">        This uses by default the key ``dupefilter:&lt;timestamp&gt;``. When using the</span>
<span class="ss">        ``scrapy_redis.scheduler.Scheduler`` class, this method is not used as</span>
<span class="ss">        it needs to pass the spider name in the key.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        settings : scrapy.settings.Settings</span>

<span class="ss">        Returns</span>
<span class="ss">        -------</span>
<span class="ss">        RFPDupeFilter</span>
<span class="ss">            A RFPDupeFilter instance.</span>


<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_redis_from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">XXX</span><span class="p">:</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">creates</span><span class="w"> </span><span class="n">one</span><span class="o">-</span><span class="nc">time</span><span class="w"> </span><span class="k">key</span><span class="p">.</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">this</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">standalone</span><span class="w"> </span><span class="n">dupefilter</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">scrapy</span><span class="s1">&#39;s default scheduler</span>
<span class="s1">        # if scrapy passes spider on open() method this wouldn&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">needed</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">TODO</span><span class="p">:</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">SCRAPY_JOB</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">fallback</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nc">timestamp</span><span class="p">.</span><span class="w"></span>
<span class="w">        </span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaults</span><span class="p">.</span><span class="n">DUPEFILTER_KEY</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;timestamp&#39;</span><span class="err">:</span><span class="w"> </span><span class="nc">int</span><span class="p">(</span><span class="nc">time</span><span class="p">.</span><span class="nc">time</span><span class="p">())</span><span class="err">}</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;DUPEFILTER_DEBUG&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="o">=</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">crawler</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Returns instance from crawler.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        crawler : scrapy.crawler.Crawler</span>

<span class="ss">        Returns</span>
<span class="ss">        -------</span>
<span class="ss">        RFPDupeFilter</span>
<span class="ss">            Instance of RFPDupeFilter.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="n">from_settings</span><span class="p">(</span><span class="n">crawler</span><span class="p">.</span><span class="n">settings</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">request_seen</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Returns True if request was already seen.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        request : scrapy.http.Request</span>

<span class="ss">        Returns</span>
<span class="ss">        -------</span>
<span class="ss">        bool</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">通过self</span><span class="p">.</span><span class="n">request_fingerprint</span><span class="w"> </span><span class="n">会生一个sha1的指纹</span><span class="w"></span>
<span class="w">        </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="n">added</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">exists</span><span class="p">.</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">添加进一个Redis集合如果self</span><span class="p">.</span><span class="n">key这个集合中存在fp这个集合会返回1</span><span class="w"> </span><span class="n">不存在返回0</span><span class="w"></span>
<span class="w">        </span><span class="n">added</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Returns a fingerprint for a given request.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        request : scrapy.http.Request</span>

<span class="ss">        Returns</span>
<span class="ss">        -------</span>
<span class="ss">        str</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_spider</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spider</span><span class="p">.</span><span class="n">settings</span><span class="w"></span>
<span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_redis_from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dupefilter_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="ss">&quot;SCHEDULER_DUPEFILTER_KEY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaults</span><span class="p">.</span><span class="n">SCHEDULER_DUPEFILTER_KEY</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dupefilter_key</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="p">.</span><span class="n">name</span><span class="err">}</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;DUPEFILTER_DEBUG&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="o">=</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Delete data on close. Called by Scrapy&#39;s scheduler.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        reason : str, optional</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">clear</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Clears fingerprints data.&quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="k">key</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">spider</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Logs given request.</span>

<span class="ss">        Parameters</span>
<span class="ss">        ----------</span>
<span class="ss">        request : scrapy.http.Request</span>
<span class="ss">        spider : scrapy.spiders.Spider</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">debug</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Filtered duplicate request: %(request)s&quot;</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;request&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">request</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="err">}</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">logdupes</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;Filtered duplicate request %(request)s&quot;</span><span class="w"></span>
<span class="w">                   </span><span class="ss">&quot; - no more duplicates will be shown&quot;</span><span class="w"></span>
<span class="w">                   </span><span class="ss">&quot; (see DUPEFILTER_DEBUG to show all duplicates)&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;request&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">request</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;spider&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">spider</span><span class="err">}</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">logdupes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>我们主要看他这个方法</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">request_seen</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="ss">&quot;&quot;&quot;Returns True if request was already seen.</span>

<span class="ss">    Parameters</span>
<span class="ss">    ----------</span>
<span class="ss">    request : scrapy.http.Request</span>

<span class="ss">    Returns</span>
<span class="ss">    -------</span>
<span class="ss">    bool</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="o">#</span> <span class="err">通过</span><span class="k">self</span><span class="p">.</span><span class="n">request_fingerprint</span> <span class="err">会生一个</span><span class="n">sha1的指纹</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="k">self</span><span class="p">.</span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="o">#</span> <span class="n">This</span> <span class="k">returns</span> <span class="n">the</span> <span class="nb">number</span> <span class="k">of</span> <span class="k">values</span> <span class="n">added</span><span class="p">,</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">already</span> <span class="k">exists</span><span class="p">.</span>

    <span class="o">#</span> <span class="err">添加进一个</span><span class="n">Redis集合如果self</span><span class="p">.</span><span class="n">key这个集合中存在fp这个集合会返回1</span> <span class="err">不存在返回</span><span class="mi">0</span>
    <span class="n">added</span> <span class="o">=</span> <span class="k">self</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">sadd</span><span class="p">(</span><span class="k">self</span><span class="p">.</span><span class="k">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
</td></tr></table>

<p>就是说request_seen()这个方法会将请求加密的那个key做判断。存在就返回1,不存在就返回0。这样就非常简答判断请求，然后过滤</p>
<h2 id="_1">总结<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ol>
<li>scrapy-redis作为对Scrapy 的调取器进行改造，将原本scrapy 的请求基于队列（Queue）内存处理，还有去重这两个部分使用redis去实现</li>
</ol>
<h2 id="_2">思考<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li>去重是如何做到的，会不会有重复</li>
</ol>
<p>去重是将request hash做成key.request他是会先序列化的，序列化的时候就包括了很多</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">request_to_dict</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert Request object to a dict.</span>

<span class="sd">    If a spider is given, it will try to find out the name of the spider method</span>
<span class="sd">    used in the callback and store that as the callback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">cb</span><span class="p">):</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">_find_method</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
    <span class="n">eb</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">errback</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">eb</span><span class="p">):</span>
        <span class="n">eb</span> <span class="o">=</span> <span class="n">_find_method</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">eb</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>  <span class="c1"># urls should be safe (safe_string_url)</span>
        <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="p">,</span>
        <span class="s1">&#39;errback&#39;</span><span class="p">:</span> <span class="n">eb</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
        <span class="s1">&#39;cookies&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span>
        <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
        <span class="s1">&#39;_encoding&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
        <span class="s1">&#39;dont_filter&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">dont_filter</span><span class="p">,</span>
        <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span>
        <span class="s1">&#39;cb_kwargs&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cb_kwargs</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Request</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">d</span>
</code></pre></div>
</td></tr></table>

<p>并不是单单对url做处理哦！所以别担心。基本参数都做处理，那岂不是美滋滋，再也不用担心我爬的竟然没去重.当然我们也是可以改装的，以去适合需求的变化</p>
<ol>
<li>hash 一次key数值进redis值大不大，能不能优良改装一下</li>
</ol>
<p>使用<a href="https://github.com/Python3WebSpider/ScrapyRedisBloomFilter">布隆过滤器</a>具体原理下次研究</p>
<p>3.如何使用scrapy-redis</p>
<p>这里是<a href="https://github.com/rmax/scrapy-redis">官方文档</a>，按照他的要求在设置就行</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">#启用Redis调度存储请求队列</span>
<span class="err">SCHEDULER = &quot;scrapy_redis.scheduler.Scheduler&quot;</span>
<span class="err"> </span>
<span class="err">#确保所有的爬虫通过Redis去重</span>
<span class="err">DUPEFILTER_CLASS = &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span>
<span class="err"> </span>
<span class="err">#默认请求序列化使用的是pickle 但是我们可以更改为其他类似的。PS：这玩意儿2.X的可以用。3.X的不能用</span>
<span class="err">#SCHEDULER_SERIALIZER = &quot;scrapy_redis.picklecompat&quot;</span>
<span class="err"> </span>
<span class="err">#不清除Redis队列、这样可以暂停/恢复 爬取</span>
<span class="err">#SCHEDULER_PERSIST = True</span>
<span class="err"> </span>
<span class="err">#使用优先级调度请求队列 （默认使用）</span>
<span class="err">#SCHEDULER_QUEUE_CLASS = &#39;scrapy_redis.queue.PriorityQueue&#39;</span>
<span class="err">#可选用的其它队列</span>
<span class="err">#SCHEDULER_QUEUE_CLASS = &#39;scrapy_redis.queue.FifoQueue&#39;</span>
<span class="err">#SCHEDULER_QUEUE_CLASS = &#39;scrapy_redis.queue.LifoQueue&#39;</span>
<span class="err"> </span>
<span class="err">#最大空闲时间防止分布式爬虫因为等待而关闭</span>
<span class="err">#SCHEDULER_IDLE_BEFORE_CLOSE = 10</span>
<span class="err"> </span>
<span class="err">#将清除的项目在redis进行处理</span>
<span class="err">ITEM_PIPELINES = {</span>
<span class="err">    &#39;scrapy_redis.pipelines.RedisPipeline&#39;: 300</span>
<span class="err">}</span>
<span class="err"> </span>
<span class="err">#序列化项目管道作为redis Key存储</span>
<span class="err">#REDIS_ITEMS_KEY = &#39;%(spider)s:items&#39;</span>
<span class="err"> </span>
<span class="err">#默认使用ScrapyJSONEncoder进行项目序列化</span>
<span class="err">#You can use any importable path to a callable object.</span>
<span class="err">#REDIS_ITEMS_SERIALIZER = &#39;json.dumps&#39;</span>
<span class="err"> </span>
<span class="err">#指定连接到redis时使用的端口和地址（可选）</span>
<span class="err">#REDIS_HOST = &#39;localhost&#39;</span>
<span class="err">#REDIS_PORT = 6379</span>
<span class="err"> </span>
<span class="err">#指定用于连接redis的URL（可选）</span>
<span class="err">#如果设置此项，则此项优先级高于设置的REDIS_HOST 和 REDIS_PORT</span>
<span class="err">#REDIS_URL = &#39;redis://user:pass@hostname:9001&#39;</span>
<span class="err"> </span>
<span class="err">#自定义的redis参数（连接超时之类的）</span>
<span class="err">#REDIS_PARAMS  = {}</span>
<span class="err"> </span>
<span class="err">#自定义redis客户端类</span>
<span class="err">#REDIS_PARAMS[&#39;redis_cls&#39;] = &#39;myproject.RedisClient&#39;</span>
<span class="err"> </span>
<span class="err">#如果为True，则使用redis的&#39;spop&#39;进行操作。</span>
<span class="err">#如果需要避免起始网址列表出现重复，这个选项非常有用。开启此选项urls必须通过sadd添加，否则会出现类型错误。</span>
<span class="err">#REDIS_START_URLS_AS_SET = False</span>
<span class="err"> </span>
<span class="err">#RedisSpider和RedisCrawlSpider默认 start_usls 键</span>
<span class="err">#REDIS_START_URLS_KEY = &#39;%(name)s:start_urls&#39;</span>
<span class="err"> </span>
<span class="err">#设置redis使用utf-8之外的编码</span>
<span class="err">#REDIS_ENCODING = &#39;latin1&#39;</span>
</code></pre></div>
</td></tr></table>

<ol>
<li>实践案例有吗？</li>
</ol>
<p><a href="https://github.com/jusk9527/ArticleSpider">可以看下爬取scrapy-redis全网的当当网</a></p>
<h2 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>https://zhuanlan.zhihu.com/p/79120407</p>
<p>https://www.jianshu.com/p/2104d11ee0a2</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../06_scrapy_log/06_scrapy_log/" title="Scrapy 源码 log" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Scrapy 源码 log
              </span>
            </div>
          </a>
        
        
          <a href="../../08_scrapy_scrapyd/08_scrapy_scrapyd/" title="Scrapy scrapyd" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Scrapy scrapyd
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 - 2020 PegasusWang
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/jusk9527" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>